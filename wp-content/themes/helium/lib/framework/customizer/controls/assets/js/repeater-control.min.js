;(function(f,b){var c=f.customize;c&&(c.Youxi=c.Youxi||{},c.Youxi.RepeaterControl=c.Control.extend({add:function(){var a,d;0!==b("#tmpl-"+this.templateSelector).length&&(a=f.template(this.templateSelector))&&this.list&&(d=_.extend({},this.params,{index:this.index++,title_template:this.titleTemplate}),this.list.append(a(d)));this.updateItems();this.toggle(this.items.last());this.update()},remove:function(a){a.remove();this.updateItems();this.update()},update:function(){var a=this,d=[],b=a.list.sortable("toArray",{attribute:"data-index"}),c=a.list.find(":input").serializeJSON();c&&c[a.params.item_key]&&(c=c[a.params.item_key],_.each(b,function(b){c[b]?d.push(c[b]):d.push(a.params.item_defaults)}));a.setting.set(d)},updateTitle:function(a){var c=b(a).data("index"),e=b(a).find(":input").serializeJSON();(e=e[this.params.item_key])&&(e=e[c])&&b(a).find(".youxi-repeater-control-item-title h4").html(this.titleTemplate(e))},updateItems:function(){this.list.sortable("refresh");this.items=this.list.find(".youxi-repeater-control-item")},toggle:function(a){b(a).find(".youxi-repeater-control-item-inside").is(":visible")?this.collapseItem(a):(this.collapseItem(this.items.not(a)),this.expandItem(a))},collapseItem:function(a){b(a).find(".youxi-repeater-control-item-inside").slideUp("fast")},expandItem:function(a){b(a).find(".youxi-repeater-control-item-inside").slideDown("fast")},getItem:function(a){return b(a).closest(".youxi-repeater-control-item")},renderContent:b.noop,ready:function(){if(b.fn.serializeJSON&&b.fn.sortable){var a=this;_.bindAll(a,"update","add","remove","toggle","updateTitle");a.list=a.container.find(".youxi-repeater-control-list");a.items=a.list.find(".youxi-repeater-control-item");a.index=a.items.length;a.titleTemplate=_.template(a.params.item_title,null,{evaluate:/<#([\s\S]+?)#>/g,interpolate:/\{\{\{([\s\S]+?)\}\}\}/g,escape:/\{\{([^\}]+?)\}\}(?!\})/g,variable:"data"});a.list.sortable({axis:"y",items:".youxi-repeater-control-item",update:a.update});_.each(a.items,a.updateTitle);a.container.on("change",":input",function(){a.updateTitle(a.getItem(this));a.update()});a.container.on("click",".youxi-repeater-control-add-item",function(b){a.add();b.preventDefault()});a.container.on("click",".youxi-repeater-control-remove-item",function(b){a.remove(a.getItem(this));b.preventDefault()});a.container.on("click",".youxi-repeater-control-item-top",function(b){a.toggle(a.getItem(this));b.preventDefault()})}}}),b.extend(c.controlConstructor,{youxi_repeater:c.Youxi.RepeaterControl}))})(window.wp,jQuery);