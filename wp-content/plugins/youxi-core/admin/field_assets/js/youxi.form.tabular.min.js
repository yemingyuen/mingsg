/**
 * Youxi Tabular Form Field JS
 *
 * This script contains the initialization code for the tabular form field.
 *
 * @package   Youxi Core
 * @author    Mairel Theafila <maimairel@gmail.com>
 * @copyright Copyright (c) 2013-2015, Mairel Theafila
 */
;(function(a,h,k,l){wp.media&&a.widget&&(a.widget("youxi.tabularinput",{options:{confirmDelRow:"",confirmDelCol:"",fixedRows:!1,fixedCols:!1,inputMode:"text",textareaRows:4,fieldName:null,minColumns:2,maxColumns:10,minRows:2,maxRows:0},templates:{row:wp.media.template("youxi-tabular-row"),cell:wp.media.template("youxi-tabular-cell"),header:wp.media.template("youxi-tabular-header"),rowControls:wp.media.template("youxi-tabular-row-controls"),colControls:wp.media.template("youxi-tabular-col-controls")},_init:function(){this.options.minRows=Math.max(this.options.minRows,1);this.options.minColumns=Math.max(this.options.minColumns,1);this._refreshButtons()},_create:function(){this._on({"click .youxi-tabular-controls button[data-action]":function(b){var c,d=a(b.target).closest("[data-action]");if(d&&d.length)switch(c=d.data("action"),c){case "add-col-after":case "add-col-before":this.options.fixedColumns||this.options.maxColumns&&!(this._getColumnCount()+1<=this.options.maxColumns)||(this.addColumn(d,c.split("l-")[1]),this._refreshButtons());break;case "delete-col":!this.options.fixedColumns&&this._getColumnCount()-1>=this.options.minColumns&&confirm(this.options.confirmDelCol)&&(this.deleteColumn(d),this._refreshButtons());break;case "add-row-after":case "add-row-before":this.options.fixedRows||this.options.maxRows&&!(this._getRowCount()+1<=this.options.maxRows)||(this.addRow(d,c.split("w-")[1]),this._reIndex(),this._refreshButtons());break;case "delete-row":!this.options.fixedRows&&this._getRowCount()-1>=this.options.minRows&&confirm(this.options.confirmDelRow)&&(this.deleteRow(d),this._reIndex(),this._refreshButtons())}b.stopPropagation();b.preventDefault()}})},addColumn:function(b,c){var d=this,e=b.closest("th"),f=e.index(".youxi-tabular-controls"),g=e.parent().next("tr").children(".youxi-tabular-header").eq(f);e[c](this.templates.colControls());g[c](this.templates.header({fieldName:this.options.fieldName}));a("table",this.element).find("tbody > .youxi-tabular-row").each(function(b){a(this).children(".youxi-tabular-cell").eq(f)[c](d._getColHtml(b))})},deleteColumn:function(b){b=b.closest("th");var c=b.index(".youxi-tabular-controls"),d=b.parent().next("tr").children(".youxi-tabular-header").eq(c);b.remove();d.remove();a("table",this.element).find("tbody > .youxi-tabular-row").each(function(){a(this).children(".youxi-tabular-cell").eq(c).remove()})},addRow:function(b,a){b.closest(".youxi-tabular-row")[a](this._getRowHtml())},deleteRow:function(a){a.closest(".youxi-tabular-row").remove()},_reIndex:function(){var b=this;a("table > tbody",this.element).children(".youxi-tabular-row").each(function(c){a(this).find(".youxi-tabular-field").attr("name",b.options.fieldName+"[cells]["+c+"][]")})},_refreshButtons:function(){var b=!this.options.maxColumns||this._getColumnCount()+1<=this.options.maxColumns,c=!this.options.maxRows||this._getRowCount()+1<=this.options.maxRows,d=this._getColumnCount()-1>=this.options.minColumns,e=this._getRowCount()-1>=this.options.minRows;a('[data-action^="add-col-"]',this.element).attr("disabled",!b);a('[data-action^="add-row-"]',this.element).attr("disabled",!c);a('[data-action="delete-col"]',this.element).attr("disabled",!d);a('[data-action="delete-row"]',this.element).attr("disabled",!e)},_getRowHtml:function(){var b=this.options.fixedRows?"":this.templates.rowControls(),c=this._getRowCount(),d=a.map(Array(this._getColumnCount()),a.proxy(function(){return this._getColHtml(c)},this));return this.templates.row({tabularRowControls:b,tabularRowCells:d.join("")})},_getColHtml:function(a){return this.templates.cell({rowIndex:a,inputMode:this.options.inputMode,textareaRows:this.options.textareaRows,fieldName:this.options.fieldName})},_getColumnCount:function(){return a("table > thead",this.element).find(".youxi-tabular-header").length},_getRowCount:function(){return a("table > tbody",this.element).children(".youxi-tabular-row").length}}),a.Youxi.Form.Manager&&a.Youxi.Form.Manager.addCallbacks("tabular",function(b){a.fn.tabularinput&&a(".youxi-tabular-input",b).each(function(){a(this).is(":youxi-tabularinput")||a(this).tabularinput(a(this).data())})},function(b){a.fn.tabularinput&&a(":youxi-tabularinput",b).each(function(){a(this).tabularinput("destroy")})}))})(jQuery,window,document);