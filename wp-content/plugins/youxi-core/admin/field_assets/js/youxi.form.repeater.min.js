/**
 * Youxi Repeater Form Field JS
 *
 * This script contains the repeater form field widget.
 *
 * @package   Youxi Core
 * @author    Mairel Theafila <maimairel@gmail.com>
 * @copyright Copyright (c) 2013-2015, Mairel Theafila
 */
;(function(b,g,h,k){wp.media&&wp.media.template&&b.widget&&(b.widget("youxi.fieldrepeater",{options:{max:0,min:1,depth:0,templateId:"",templateVars:{},confirmRemove:"Are you sure you want to delete this row?"},_init:function(){var a=this;this._depth=this.options.depth;delete this.options.depth;this._refresh();this.options.templateVars["index_"+this._depth]=this._getRows().length;this._getRows().each(function(c){a._renderPreview.apply(a,[a._getInputs(this).first()]);b(this).find(".youxi-repeater").not(":youxi-fieldrepeater").filter(function(){return a.ownsElement(this)}).each(function(){var d=b.extend(!0,{},a.options.templateVars);d["index_"+a._depth]=c;b(this).fieldrepeater(b.extend(!0,b(this).data(),{templateVars:d}))})})},_create:function(){this.templates={};this.templates.row=wp.media.template(this.options.templateId);b("#tmpl-"+this.options.templateId+"-preview").length&&(this.templates.preview=wp.media.template(this.options.templateId+"-preview"));this._on({"click > fieldset button[data-action]":function(a){var c=b(a.target).closest("button"),d=c.data("action");this.ownsElement(c)&&b.isFunction(this[d])&&this[d].apply(this,[c[0]]);a.stopPropagation()},"change :input:not(:disabled):not(:button)":function(a){a=b(a.target);this.ownsElement(a)&&this._renderPreview.apply(this,[a])}})},_renderPreview:function(a){if(this.templates.preview&&this.ownsElement(a)){var c,d={},e=a.closest(".youxi-repeater-row"),f=a.closest("[data-field-scope]").data("field-scope");a=this._getInputs(e);b.map(a.serializeArray(),function(a){c=a.name;c=c.replace(/(\]\[|\[|\]|\[\])/g,"_");c=c.replace(f,"");c=c.replace(/^_|_$/g,"");a.value&&(d[c]=a.value)});e.find(" > .youxi-repeater-row-header .youxi-repeater-row-title").html(_.isEmpty(d)?"":this.templates.preview(d))}},_refresh:function(){var a=this,c={add:0!==this.options.max&&this._getRows().length>=this.options.max,remove:this._getRows().length<=this.options.min};this.element.find("button[data-action]").each(function(){a.ownsElement(this)&&c.hasOwnProperty(b(this).data("action"))&&b(this).attr("disabled",c[b(this).data("action")])})},_getInputs:function(a){var c=this;return b(a).find(":input:not(:disabled):not(:button)").filter(function(){return c.ownsElement(this)})},_getRows:function(){return b(" > fieldset > .youxi-repeater-fields",this.element).children(".youxi-repeater-row")},ownsElement:function(a){return _.isElement((a=b(a))[0])&&a.parents(":youxi-fieldrepeater")[0]==this.element[0]},edit:function(a){var c=this;a=b(a).closest(".youxi-repeater-row");a.siblings(".youxi-repeater-row").removeClass("editing").find('button[data-action="edit"]').filter(function(){return c.ownsElement(this)}).removeClass("active");a.toggleClass("editing").find('button[data-action="edit"]').filter(function(){return c.ownsElement(this)}).toggleClass("active")},remove:function(a){this._getRows().length>this.options.min&&confirm(this.options.confirmRemove)&&((a=b(a).closest(".youxi-repeater-row"))&&a.length&&b.Youxi.Form.Manager.destroy(a),a.remove(),this._refresh())},add:function(){var a=this;if(0==this.options.max||this._getRows().length<this.options.max){var c=b(this.templates.row(this.options.templateVars));b(" > fieldset > .youxi-repeater-fields",this.element).first().append(c);b.Youxi.Form.Manager.initialize(c);c.find(":youxi-fieldrepeater").each(function(){var c=b(this).fieldrepeater("option","templateVars"),c=b.extend(!0,{},c,a.options.templateVars);b(this).fieldrepeater("option","templateVars",c)});this._renderPreview(this._getInputs(c).first());this.options.templateVars["index_"+this._depth]++;this._refresh();this.edit(c)}}}),b.Youxi.Form.Manager&&b.Youxi.Form.Manager.addCallbacks("repeater",function(a){b.fn.fieldrepeater&&b(".youxi-repeater",a).each(function(){b(this).is(":youxi-fieldrepeater")||b(this).fieldrepeater(b(this).data())})},function(a){b.fn.fieldrepeater&&b(":youxi-fieldrepeater",a).each(function(){b(this).fieldrepeater("destroy")})}))})(jQuery,window,document);