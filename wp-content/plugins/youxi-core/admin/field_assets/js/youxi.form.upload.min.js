/**
 * Youxi Uploader Form Field JS
 *
 * This script contains the initialization code for the image uploader form field.
 *
 * @package   Youxi Core
 * @author    Mairel Theafila <maimairel@gmail.com>
 * @copyright Copyright (c) 2013-2015, Mairel Theafila
 */
;(function(b,e,f,g){if("undefined"!=typeof wp&&wp.media&&b.widget&&b.ui.sortable){var c=wp.media,d=c.view.MediaFrame.Select.extend({createStates:function(){c.view.MediaFrame.Select.prototype.createStates.apply(this,arguments);this.options.embed&&this.states.add(new c.controller.Embed({metadata:{}}))},bindHandlers:function(){c.view.MediaFrame.Select.prototype.bindHandlers.apply(this,arguments);this.on("toolbar:create:main-embed",this.mainEmbedToolbar,this);this.on("content:render:embed",this.embedContent,this)},createSelectToolbar:function(a,b){b=_.extend({},b||this.options.button||{},{controller:this});a.view=new c.view.Toolbar.Select(b)},embedContent:function(){var a=(new c.view.Embed({controller:this,model:this.state()})).render();this.content.set(a);a.url.focus()},mainEmbedToolbar:function(a){a.view=new c.view.Toolbar.Embed({controller:this})}});b.widget("youxi.mediauploader",{options:{fieldName:"",multiple:!1,returnType:"id",returnUrlSize:"full",title:"",buttonText:""},_mediaFrame:null,_mediaTemplate:c.template("youxi-media-field"),_init:function(){this._refreshButton()},_create:function(){this._createMediaFrame();this._on({"click .youxi-media-button":function(a){this.open();a.stopPropagation()},"click .youxi-media-preview-remove":function(a){this.removeItem(a.target);a.stopPropagation()}});this.options.multiple&&b(".youxi-media-previews",this.element).sortable({items:"> .youxi-media-preview-item",tolerance:"pointer"})},_createMediaFrame:function(){if(!this._mediaFrame){var a=c.view.MediaFrame.Select;"url"==this.options.returnType&&(a=d);this._mediaFrame=new a({title:this.options.title,library:{type:"image"},button:{text:this.options.buttonText},multiple:this.options.multiple});this._mediaFrame.on("select",this._handleSelection,this);this._mediaFrame.state("embed").on("select",this._handleEmbed,this)}},_handleSelection:function(){var a=this._mediaFrame.state().get("selection");a&&(a.map(function(a){var c={id:a.id,url:this._getAttachmentSize(a,"thumbnail").url,fieldName:this.options.fieldName,fieldNamePostfix:this.options.multiple?"[]":""};"url"==this.options.returnType&&(c.id=this._getAttachmentSize(a,this.options.returnUrlSize).url);b(".youxi-media-previews",this.element).append(this._mediaTemplate(c))},this),this._refreshButton())},_handleEmbed:function(){var a=this._mediaFrame.state().props.toJSON(),a={id:a.url||"",url:a.url||"",fieldName:this.options.fieldName,fieldNamePostfix:this.options.multiple?"[]":""};b(".youxi-media-previews",this.element).append(this._mediaTemplate(a));this._refreshButton()},_getAttachmentSize:function(a,b){var c=a.attributes.sizes||{};return _.has(c,b)?_.pick(c[b],"url"):{url:a.url}},_destroy:function(){this._mediaFrame&&this._mediaFrame.dispose();this._super()},_refreshButton:function(){var a=1<=b(".youxi-media-preview-item",this.element).length;this.options.multiple||b(".youxi-media-button",this.element).toggle(!a);b(".youxi-media-no-item",this.element).prop("disabled",a)},removeItem:function(a){b(a).parents(".youxi-media-preview-item").remove();this._refreshButton()},open:function(){this._mediaFrame||this._createMediaFrame();this._mediaFrame.open()}});b.widget("youxi.fileuploader",{options:{fieldName:"",title:"",buttonText:"",alwaysReturnUrl:!1,enableEmbed:!0,libraryType:""},_mediaFrame:null,_init:function(){this._refreshButtons()},_create:function(){this._mediaFrame||(this._mediaFrame=new d(_.extend({title:this.options.title,button:{text:this.options.buttonText},embed:this.options.enableEmbed,multiple:!1},this.options.libraryType?{library:{type:this.options.libraryType}}:{})),this._mediaFrame.on("select",this._handleSelection,this),this._mediaFrame.state("embed").on("select",this._handleEmbed,this));this._on({"click .youxi-uploader-button":function(a){this.open();a.stopPropagation()},"click .youxi-uploader-feedback":function(a){this.open();a.stopPropagation()},"click .youxi-uploader-remove":function(a){this.removeItem();a.stopPropagation()}})},_handleSelection:function(){var a=this._mediaFrame.state().get("selection");a&&(a.map(function(a){a&&a.attributes&&this._feedback(a.attributes.url,a.attributes[this.options.alwaysReturnUrl?"url":"id"])},this),this._refreshButtons())},_handleEmbed:function(){var a=this._mediaFrame.state().props.toJSON();this._feedback(a.url||"",a.url||"");this._refreshButtons()},_refreshButtons:function(){var a=this.element.find(".youxi-uploader-value").val();this.element.find(".youxi-uploader-button").toggle(!a);this.element.find(".youxi-uploader-remove").toggle(!!a)},_destroy:function(){this._mediaFrame&&this._mediaFrame.dispose();this._super()},_feedback:function(a,b){this.element.find(".youxi-uploader-feedback").val(a);this.element.find(".youxi-uploader-value").val(b)},removeItem:function(){this.element.find(".youxi-uploader-feedback, .youxi-uploader-value").val("");this._refreshButtons()},open:function(){this._mediaFrame||this._createMediaFrame();this._mediaFrame.open()}});b.Youxi.Form.Manager&&(b.Youxi.Form.Manager.addCallbacks("media_uploader",function(a){b.fn.mediauploader&&b(".youxi-media-uploader",a).each(function(){b(this).mediauploader(b(this).data())})},function(a){b.fn.mediauploader&&b(".youxi-media-uploader:youxi-mediauploader",a).each(function(){b(this).mediauploader("destroy")})}),b.Youxi.Form.Manager.addCallbacks("file_uploader",function(a){b.fn.fileuploader&&b(".youxi-file-uploader",a).each(function(){b(this).fileuploader(b(this).data())})},function(a){b.fn.fileuploader&&b(".youxi-file-uploader:youxi-fileuploader",a).each(function(){b(this).fileuploader("destroy")})}))}})(jQuery,window,document);