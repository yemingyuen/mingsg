/**
 * Youxi Shortcode Editor Plugin
 *
 * This script contains the modal shortcode editor script
 *
 * @package   Youxi Shortcode
 * @author    Mairel Theafila <maimairel@yahoo.com>
 * @copyright Copyright (c) 2013, Mairel Theafila
 */
jQuery.Youxi=jQuery.Youxi||{};(function(b,h,f,k){wp&&wp.media&&(b.extend(!0,b.Youxi,{Shortcode:{Editor:function(a,e,d){var c=b.Youxi.Shortcode.EditorManager.getEditor(),g=_.once(function(){c.off("submit",g);d.apply(this,arguments)});c.on("submit",g);c.open();c.load(a,e)},EditorModal:wp.media.view.Modal.extend({className:"youxi-modal-wrap",template:wp.template("youxi-modal"),events:function(){return _.extend(wp.media.view.Modal.prototype.events,{'click [data-dismiss="modal"]':"escapeHandler"})},content:function(a){a instanceof Backbone.View&&(a.on("loading",this.contentLoading,this),a.on("loaded",this.contentLoaded,this));this.views.set(".youxi-modal",a);return this},propagate:function(a){var e=wp.media.view.Modal.prototype.propagate.apply(this,arguments),d=b.Event(a+".youxi.modal");this.$el.trigger(d);return e},contentLoading:function(){this.$el.addClass("youxi-modal-loading")},contentLoaded:function(){this.$el.removeClass("youxi-modal-loading")}}),EditorForm:wp.media.View.extend({tagName:"form",className:"youxi-modal-dialog",template:wp.template("youxi-shortcode-editor"),events:{submit:"submit"},initialize:function(){wp.media.View.prototype.initialize.apply(this,arguments);this.modal=new b.Youxi.Shortcode.EditorModal({controller:this,title:this.options.title});this.modal.content(this);this.model=new Backbone.Model({title:"",form:"",open:!1});this.closeButton=new Backbone.View({tagName:"button",className:"close",attributes:{type:"button","data-dismiss":"modal","aria-hidden":"true"}});this.closeButton.$el.html("&times;");this.title=new Backbone.View({tagName:"h2",className:"youxi-modal-title"});this.form=new Backbone.View({className:"youxi-shortcode-editor-form"});this.buttons=[new wp.media.view.Button({text:"Save",style:"primary",size:"large",tagName:"button",attributes:{type:"submit"}}),new wp.media.view.Button({text:"Reset Fields",size:"large",tagName:"button",attributes:{type:"reset"}})];this.setupViews();this.bindHandlers()},setupViews:function(){this.views.add(".youxi-modal-header",[this.closeButton,this.title]);this.views.add(".youxi-modal-body",this.form);this.views.add(".youxi-modal-footer",this.buttons)},bindHandlers:function(){this.model.on("change:form",this.afterLoad,this);this.on("open",this.afterOpen,this);this.on("close",this.afterClose,this)},load:function(a,b,d){var c=this;c.trigger("loading");wp.ajax.post("get_shortcode_editor",{shortcode:a,shortcodeData:b}).done(function(a){c.trigger("loaded");c.model.set({title:a.title,form:a.html})})},unload:function(a){b.Youxi.Form&&b.Youxi.Form.Manager&&b.Youxi.Form.Manager.destroy(this.form.$el);this.title.$el.empty();this.form.$el.empty();a&&a.close&&(this.model.set("title","",{silent:!0}),this.model.set("form","",{silent:!0}))},submit:function(a){a.preventDefault();b.fn.serializeJSON&&("undefined"!==typeof tinymce&&_.each(this.form.$("textarea"),function(a){(a=tinymce.get(a.id))&&a instanceof tinymce.Editor&&a.save()},this),this.trigger("submit",this.$el.serializeJSON()),this.close())},afterLoad:function(a){this.title.$el.html(a.get("title"));this.form.$el.html(a.get("form"));b.Youxi.Form&&b.Youxi.Form.Manager&&b.Youxi.Form.Manager.initialize(this.form.$el)},afterOpen:function(){this.model&&this.model.set("open",!0)},afterClose:function(){this.unload({close:!0});this.off("submit");this.model&&this.model.set("open",!1)}})}}),b.Youxi.Shortcode.EditorManager={editorPool:[],init:function(){var a=this;b(f).on("close.youxi.modal",".youxi-modal-wrap",function(){a.getActiveEditors().length||b("body").removeClass("youxi-modal-open")}).on("open.youxi.modal",".youxi-modal-wrap",function(){b("body").addClass("youxi-modal-open")})},getInactiveEditors:function(){return b.map(this.editorPool,function(a){if(!a.model.get("open"))return a})},getActiveEditors:function(){return b.map(this.editorPool,function(a){if(a.model.get("open"))return a})},getEditor:function(){var a=this.getInactiveEditors().shift();a||(a=new b.Youxi.Shortcode.EditorForm,this.editorPool.push(a));return a}},b(f).ready(function(){b.Youxi.Shortcode.EditorManager.init()}),_.each(["open","close","attach","detach","escape"],function(a){b.Youxi.Shortcode.EditorForm.prototype[a]=function(b){this.modal&&this.modal[a].apply(this.modal,arguments);return this}}))})(window.jQuery,window,document);