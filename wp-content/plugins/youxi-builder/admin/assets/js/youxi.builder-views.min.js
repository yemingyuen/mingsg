/**
 * Youxi Builder Views JS
 *
 * This script contains the page builder Backbone Views
 *
 * @package   Youxi Builder
 * @author    Mairel Theafila <maimairel@yahoo.com>
 * @copyright Copyright (c) 2013, Mairel Theafila
 */
jQuery.Youxi=jQuery.Youxi||{};(function(c,n,m,q){var b=c.Youxi.Builder,p=b.l10n;c(n);b.view.Wrapper=wp.media.View.extend({className:"youxi-builder-wrapper",template:wp.template("youxi-builder-wrapper"),initialize:function(){_.defaults(this.options,{editorId:"content"});this.createMenu();this.createRoot();this.bindHandlers()},bindHandlers:function(){this.listenTo(this,"show",this.importFromEditor);this.listenTo(this.root,"insert:tinymce",this.exportToEditor);this.listenTo(this,"show",this.disableEditorExpand);this.listenTo(this,"hide",this.restoreEditorExpand)},disableEditorExpand:function(){this.editorExpandEnabled=c("#editor-expand-toggle").prop("checked");c("#editor-expand-toggle").prop("checked",!1).prop("disabled",!0).triggerHandler("change");c(m.getElementById(this.options.editorId)).hide()},restoreEditorExpand:function(){c("#editor-expand-toggle").prop("checked",this.editorExpandEnabled).prop("disabled",!1).triggerHandler("change")},createMenu:function(){this.menu=new b.view.Menu({controller:this});this.views.add(".youxi-builder-header",this.menu)},createToolbar:function(){this.toolbar=new b.view.Toolbar({controller:this});this.views.add(".youxi-builder-header",this.toolbar)},createRoot:function(){this.root=new b.view.Root({parent:this});this.views.add(".youxi-builder-content-wrap",this.root)},exportToEditor:function(a){if(!_.isUndefined(tinymce)){var b=tinymce.get(this.options.editorId)||m.getElementById(this.options.editorId);b instanceof tinymce.Editor?b.isHidden()?(b.setContent(a,{format:"raw"}),b.save({format:"raw",no_events:!0})):(b.getParam("wpautop",!0)&&"object"==typeof switchEditors&&(a=switchEditors.wpautop(a)),b.setContent(a),b.save()):_.isElement(b)&&/TEXTAREA/i.test(b.nodeName)&&(b.value=a)}},importFromEditor:function(){if("undefined"!=typeof tinymce){var a=tinymce.get(this.options.editorId),f="";a&&a instanceof tinymce.Editor?f=a.save():c("textarea#"+this.options.editorId).length&&(f=c("textarea#"+this.options.editorId).val());switch(b.settings.parseMethod){case "ajax":wp.ajax.post("parse_shortcode_to_json",{content:f}).done(_.bind(function(a){this.root.clear();this.root.populate(a.parsed)},this));break;default:a=b.Shortcode.toJSON(f),this.root.clear(),this.root.populate(a)}}},attach:function(){if(this.views.attached)return this;this.views.rendered||this.render();this.$el.appendTo("#wp-"+this.options.editorId+"-editor-container");this.views.attached=!0;this.views.ready();return this.trigger("attach")},show:function(){var a=this.$el;if(a.is(":visible"))return this;this.views.attached||this.attach();a.show();return this.trigger("show")},hide:function(){if(!this.views.attached||!this.$el.is(":visible"))return this;this.$el.hide();return this.trigger("hide")},isHidden:function(){return!this.$el.is(":visible")},dispose:function(){this.stopListening();this.restoreEditorExpand();wp.media.View.prototype.dispose.apply(this,arguments)}});b.view.Menu=wp.media.View.extend({className:"youxi-builder-menu",template:wp.template("youxi-builder-menu"),events:{"click .youxi-builder-menu-tabs a":"tabclick"},initialize:function(){var a=_.map(b.model.ShortcodeButton.getTabs()||[],function(a){return new b.view.MenuTab(_.extend(a,{controller:this}))},this),f=_.map(b.model.ShortcodeButton.getItems()||[],function(a){return new b.view.MenuTabItem(_.extend(a,{controller:this}))},this);this.views.add(".youxi-builder-menu-tabs",a);this.views.add(".youxi-builder-menu-items",f)},ready:function(){var a=this.$('.youxi-builder-menu-tab:first-child a[href^="#"]');a.length&&this.changetab(a)},tabclick:function(a){var b=c(a.target).closest('.youxi-builder-menu-tab a[href^="#"]');b.length&&this.changetab(b);a.preventDefault()},changetab:function(a){a.closest(".youxi-builder-menu-tab").addClass("active").siblings().removeClass("active");this.$(".youxi-builder-menu-items").find(a.attr("href")).show().siblings().hide();this.trigger("changetab")}});b.view.MenuTab=wp.media.View.extend({tagName:"li",className:"youxi-builder-menu-tab",template:wp.template("youxi-builder-menu-tab"),initialize:function(){_.defaults(this.options,{href:"#",label:""})}});b.view.MenuTabItem=wp.media.View.extend({className:"youxi-builder-menu-tab-content",template:wp.template("youxi-builder-menu-tab-content"),initialize:function(){this.views.set(".youxi-builder-component-list",this.collection.map(function(a){return new b.view.ShortcodeButton({model:a,controller:this.controller})},this))},ready:function(){c.fn.draggable&&_.each(this.views.get(".youxi-builder-component-list"),function(a){a.$el.draggable({scope:"youxi-builder",helper:"clone",zIndex:99999,stop:function(){c(this).removeData("isDropped")}})})}});b.view.ShortcodeButton=wp.media.View.extend({tagName:"li",className:"youxi-builder-component",template:wp.template("youxi-builder-shortcode-button"),initialize:function(){_.defaults(this.options,{icon:this.model.get("icon"),label:this.model.get("label")})},attributes:function(){return this.model.get("dataset")}});b.view.Panel=wp.media.View.extend({template:wp.template("youxi-builder-panel"),onMessages:{"copy:view":function(a){_.has(a.data,"object")&&a.source instanceof b.view.Panel&&this.populate(a.data.object,{at:a.source.$el.index()+1,compile:!0})}},passMessages:{"compile:shortcode":".","sort:subview:start":".","sort:subview:stop":"."},initialize:function(){this.createController();this.createContents();this.constructUI();this.bindHandlers();Backbone.Courier.add(this);_.defaults(this.options,{type:this.controller.get("type")});this.$el.data("backbone.view",this);this.trigger("initialized",this)},ready:function(){this.childContainer&&(c.fn.droppable&&this.childContainer.$el.droppable(this.controller.droppableOptions()),c.fn.sortable&&this.childContainer.$el.sortable(this.controller.sortableOptions()),c.fn.disableSelection&&this.childContainer.$el.disableSelection())},bindHandlers:c.noop,createController:c.noop,createContents:function(){this.childContainer=new wp.media.View({className:"youxi-builder-panel-cw youxi-builder-"+this.controller.get("type")+"-cw",controller:this});this.views.add(".youxi-builder-panel-contents",this.childContainer)},getControlButtons:function(){var a=[];c.Youxi.Shortcode.getSetting(this.options.tag,"instant")||a.unshift(new b.view.ControlButton({controller:this,action:"edit",icon:b.settings.uiIcons.edit.icon,title:b.settings.uiIcons.edit.title}));this instanceof b.view.Column||a.push(new b.view.ControlButton({controller:this,action:"copy",icon:b.settings.uiIcons.copy.icon,title:b.settings.uiIcons.copy.title}));a.push(new b.view.ControlButton({controller:this,message:p.confirmRemoveContainer,action:"remove",icon:b.settings.uiIcons.remove.icon,title:b.settings.uiIcons.remove.title}));return a},getControlViews:function(){var a,f;f=this.getControlButtons();if(f.length)return a=new b.view.Controls({controller:this}),a.add(f),a},getTitleView:function(){return new b.view.PanelTitle({className:"youxi-builder-panel-title youxi-builder-"+this.controller.get("type")+"-title",title:c.Youxi.Shortcode.getSetting(this.options.tag,"label")})},getUIElements:function(){var a=[];this.title=this.getTitleView();this.controls=this.getControlViews();this.title instanceof b.view.PanelTitle&&a.push(this.title);this.controls instanceof b.view.Controls&&a.push(this.controls);return a},constructUI:function(){var a=this.getUIElements();_.isArray(a)&&this.views.add(".youxi-builder-"+this.controller.get("type")+"-header",a)},handleDropped:function(a){if(this.childContainer){var b=this.childContainer.$el.offset().top,d=a.coords.y,c=this.childContainer.$el.offset().left;this.maybeAddView(a,{},{x:a.coords.x-c,y:d-b})}},getDropIndex:function(a){if(c.isPlainObject(a)&&_.has(a,"y")){var b=this.childContainer.views.all(),d,e,k,h,g;h=0;for(g=b.length;h<g;h++){d=b[h].$el;e=h+1<g?b[h+1].$el:null;d=d.position().top+d.outerHeight()/2;k=e&&e.position().top+e.outerHeight()/2;if(0==h&&d>a.y)return 0;if(e&&d<a.y&&k>a.y)return e.index()}}},maybeAddView:function(a,f,d){a=a instanceof b.view.Panel?a:this.controller.toView(a);if(this.validateView(a))return this.addView(a,f,d);a&&a.remove&&a.remove()},validateView:function(a){return a instanceof b.view.Panel},addView:function(a,b,d){if(this.childContainer&&!_.contains(this.childContainer.views.all(),a))return a.on("remove",this.confirmRemoveView,this),d=this.getDropIndex(d),_.isUndefined(d)||_.extend(b,{at:d}),this.childContainer.views.add(a,b),this.trigger("add:view",a,b),a},removeView:function(a,b){this.childContainer&&_.contains(this.childContainer.views.all(),a)&&(a.off(null,null,this),this.childContainer.views.unset(a,b),this.trigger("remove:view",a,b))},remove:function(a){if(a&&a.silent)return wp.media.View.prototype.remove.apply(this,arguments);this.$el.animate({opacity:"hide",height:"hide"},_.bind(function(){wp.media.View.prototype.remove.apply(this,arguments)},this));return this},confirmRemoveView:function(a){_.isElement(a.currentTarget)&&a.view instanceof b.view.Panel&&confirm(c(a.currentTarget).data("message"))&&this.removeView(a.view)},getChildViews:function(a){if(this.childContainer){var b=this.childContainer.views.all();return a?_.sortBy(b,function(a){return a.$el.index()}):b}},_getParentView:function(){return this.parent},clear:function(){this.childContainer&&_.invoke(this.childContainer.views.all(),"remove",{silent:!0})},populate:function(a,b){this.controller&&this.controller.populate(a,b)},dispose:function(){this.childContainer&&(c.fn.droppable&&this.childContainer.$el.is(":ui-droppable")&&this.childContainer.$el.droppable("destroy"),c.fn.sortable&&this.childContainer.$el.is(":ui-sortable")&&this.childContainer.$el.sortable("destroy"),c.fn.enableSelection&&this.childContainer.$el.enableSelection());this.controller&&(this.controller.dispose&&this.controller.dispose(),this.controller.off&&this.controller.off(null,null,this));this.parent&&delete this.parent;wp.media.View.prototype.dispose.apply(this,arguments)}});b.view.RowContainer=b.view.Panel.extend({getRowSubviews:function(){return _.flatten(c.map(this.getChildViews()||[],function(a){if(a instanceof b.view.RowContainer)return a.getRowSubviews();if(a instanceof b.view.Row)return a}))}});b.view.Root=b.view.RowContainer.extend({className:"youxi-builder-panel youxi-builder-root",template:null,onMessages:_.extend({},b.view.RowContainer.prototype.onMessages,{"sort:subview:start":"sortSubviewstart","sort:subview:stop":"sortSubviewStop","compile:shortcode":function(){this.trigger("insert:tinymce",this.controller.toShortcode())}}),createController:function(){this.controller=new b.controller.Base({view:this,tag:"root",type:"root"})},createContents:function(){this.childContainer=this},getUIElements:c.noop,_getParentView:c.noop,getContainerSubviews:function(){return _.filter(this.getChildViews()||[],function(a){return a instanceof b.view.Container})},sortSubviewstart:function(a){var f=a.data.originalSource,d,e;if(f instanceof b.view.Row)d="Row",e=_.has(a.data,"columnSize")?function(b){return b.controller.get("slots")<a.data.columnSize}:function(){return!1};else if(f instanceof b.view.Container)d="Container",e=function(a){var c=b.controller.Column.isColumnContainer,d=c(f.controller.get("tag"));return function(a){return d!=c(a.controller.get("tag"))}}();else return;_.isFunction(this["get"+d+"Subviews"])&&_.isFunction(e)&&(this["lastDisabled"+d]=c([]),_.each(_.without(this["get"+d+"Subviews"](),f),function(a){a instanceof b.view[d]&&e(a)&&(this["lastDisabled"+d]=this["lastDisabled"+d].add(a.childContainer.el))},this),this["lastDisabled"+d].sortable("option","disabled",!0))},sortSubviewStop:function(a){a=a.data.originalSource;var c;a instanceof b.view.Row?c="lastDisabledRow":a instanceof b.view.Container&&(c="lastDisabledContainer");c&&_.has(this,c)&&this[c]instanceof jQuery&&(this[c].sortable("option","disabled",!1),delete this[c])}});b.view.Container=b.view.RowContainer.extend({className:"youxi-builder-panel youxi-builder-container",createController:function(){this.controller=new b.controller.Base({view:this,tag:this.options.tag,type:"container"})}});b.view.Row=b.view.Panel.extend({className:"youxi-builder-panel youxi-builder-row",onMessages:_.extend({},b.view.Panel.prototype.onMessages,{"request:slots!":function(){return this.controller.get("slots")}}),createController:function(){this.controller=new b.controller.Row({view:this,tag:this.options.tag,type:"row"})},getDropIndex:function(a){if(c.isPlainObject(a)&&_.has(a,"x")){var b=this.childContainer.views.all(),d,e,k,h,g,l;g=0;for(l=b.length;g<l;g++){d=b[g].$el;e=g+1<l?b[g+1].$el:null;k=d.position().left+d.width()/2;h=e&&e.position().left+e.width()/2;if(0==g&&(k+=parseInt(d.css("paddingLeft")),k>a.x))return 0;if(e&&k<a.x&&h>a.x)return e.index()}}},validateView:function(a){return!b.view.Panel.prototype.validateView.apply(this,arguments)||!a.controller||!a.controller.get("size")||a.controller.get("size")>this.controller.get("slots")?!1:!0}});b.view.Column=b.view.Panel.extend({className:"youxi-builder-panel youxi-builder-column",initialize:function(){var a=this.options.parent,c;b.settings.simpleColumns?c=b.controller.Column.getColumnByTag(this.options.tag):a instanceof b.view.Panel&&a.controller instanceof Backbone.Model&&(c=b.controller.Column.getBestFit(a.controller.get("slots")));_.defaults(this.options,_.pick(c||{},"size"));b.view.Panel.prototype.initialize.apply(this,arguments)},createController:function(){this.controller=new b.controller.Column(_.extend({},_.pick(this.options,"tag","size"),{view:this,type:"column"}))},getControlButtons:function(){var a=b.view.Panel.prototype.getControlButtons.apply(this,arguments);Array.prototype.unshift.apply(a,[new b.view.ControlButton({controller:this,action:"decrease",icon:b.settings.uiIcons.resizeLeft.icon,title:b.settings.uiIcons.resizeLeft.title}),new b.view.ControlButton({controller:this,action:"increase",icon:b.settings.uiIcons.resizeRight.icon,title:b.settings.uiIcons.resizeRight.title})]);return a},getUIElements:function(){var a=b.view.Panel.prototype.getUIElements.apply(this,arguments);if(_.isArray(a))return a.reverse()},refresh:function(a){this.title.set(b.controller.Column.getTitle(a));this.$el.css("width",100*a/b.settings.rowSize+"%")}});b.view.Widget=b.view.Panel.extend({className:"youxi-builder-panel youxi-builder-widget",createController:function(){this.controller=new b.controller.Base({view:this,tag:this.options.tag,type:"widget"})},createContents:c.noop});b.view.PanelTitle=wp.media.View.extend({className:"youxi-builder-panel-title",initialize:function(){_.defaults(this.options,{title:""});this.model=new Backbone.Model({title:this.options.title});this.model.on("change:title",this.refresh,this);this.refresh()},set:function(a){this.model.set("title",a)},refresh:function(){this.$el.text(this.model.get("title"))}});b.view.Controls=wp.media.View.extend({template:wp.template("youxi-builder-controls"),className:"youxi-builder-controls",add:function(a){this.views.add("ul",a);return this}});b.view.ControlButton=wp.media.View.extend({tagName:"li",template:wp.template("youxi-builder-panel-control-button"),events:{"click a":"_click"},initialize:function(){_.defaults(this.options,{action:"",title:"",message:"",icon:""})},_click:function(a){a.preventDefault();a.view=this.controller;this.controller.trigger(this.options.action,a)}})})(jQuery,window,document);