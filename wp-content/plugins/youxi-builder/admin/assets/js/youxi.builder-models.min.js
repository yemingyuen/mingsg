/**
 * Youxi Builder Models JS
 *
 * This script contains the page builder Backbone Models
 *
 * @package   Youxi Builder
 * @author    Mairel Theafila <maimairel@yahoo.com>
 * @copyright Copyright (c) 2013, Mairel Theafila
 */
jQuery.Youxi=jQuery.Youxi||{};(function(f,n,p,q){var c,k,l,g,m;c=f.Youxi.Builder=function(a){return new c.view.Wrapper(a)};_.extend(c,{model:{},view:{},controller:{}});l=c.l10n=_.isUndefined(_youxiBuilderL10n)?{}:_youxiBuilderL10n;c.settings=l.settings||{};delete l.settings;k=c.settings.shortcodes=f.extend(!0,{},youxiShortcodeSettings.args||{});k.tags=_.flatten(_.map(k.categories||[],function(a){return _.keys(a.shortcodes)})).concat(_.keys(k.orphans));c.Shortcode={regex:wp.shortcode.regexp(k.tags.join("|")),attrs:_.memoize(function(a){var b={},e,d;e=/(\w+)\s*=\s*"([^"]*)"(?:\s|$)|(\w+)\s*=\s*\'([^\']*)\'(?:\s|$)|(\w+)\s*=\s*([^\s\'"]+)(?:\s|$)|"([^"]*)"(?:\s|$)|(\S+)(?:\s|$)/g;for(a=a.replace(/[\u00a0\u200b]/g," ");d=e.exec(a);)d[1]?b[d[1].toLowerCase()]=d[2]:d[3]?b[d[3].toLowerCase()]=d[4]:d[5]?b[d[5].toLowerCase()]=d[6]:""!==d[7]?b[d[7]]=!0:""!==d[8]&&(b[d[8]]=!0);return b}),toJSON:function(a){var b,e=[],d=this.regex;for(d.lastIndex=0;b=d.exec(a);)if("["!==b[1]||"]"!==b[7]){var c=this.attrs(b[3]),h=b[5],g=d.lastIndex;h&&(h=f.Youxi.Shortcode.getSetting(b[2],"escape")?jQuery.trim(h):this.toJSON(h));e.push({tag:b[2],atts:c,content:h});d.lastIndex=g}return e.length?e:jQuery.trim(a)}};c.Helpers={getValidationStates:_.memoize(function(a,b){if(_.has(c.settings.rules,a)){var e=c.settings.rules[a],d={accept:!0,reject:!1};_.each(_.keys(d),function(a){_.has(e,a)&&(_.isArray(e[a])?d[a]=-1<_.indexOf(e[a],b):d[a]=_.isString(e[a])&&"*"==e[a])});return d}},function(){return"builder.Helpers.getValidationStates("+_.toArray(arguments).join(",")+")"}),getWrapperView:function(a){switch(a.get("type")){case "root":return c.settings.enableContainer?new c.view.Container({parent:a.view,tag:c.settings.columnContainerShortcode}):new c.view.Row({parent:a.view,tag:c.settings.rowShortcode});case "container":return new c.view.Row({parent:a.view,tag:c.settings.rowShortcode});case "row":var b=m.getBestFit(a.get("slots"));if(!_.isUndefined(b)&&_.has(b,"tag"))return new c.view.Column({parent:a.view,tag:b.tag})}},getShortcodeClass:function(a){return c.settings.enableContainer&&-1<_.indexOf(c.settings.containerShortcodes,a)?c.view.Container:a==c.settings.rowShortcode?c.view.Row:m.getColumnByTag(a)?c.view.Column:c.view.Widget}};c.model.ShortcodeButton=Backbone.Model.extend({defaults:{tag:"",label:"",atts:"",dataset:{}},initialize:function(){var a={"data-tag":this.get("tag")};_.isEmpty(this.get("atts"))||_.extend(a,{"data-atts":JSON.stringify(this.get("atts"))});this.set("dataset",a)}},{getTabs:function(){return _.map(k.categories||[],function(a){a=a.args.label;return{href:a.toLowerCase().replace(/[^a-z0-9]/gi,"-"),label:a}})},getItems:function(){return _.map(k.categories||[],function(a){var b=a.args.label;a=f.map(a.shortcodes,function(a,b){if(!a.internal&&(c.settings.enableContainer||0>_.indexOf(c.settings.containerShortcodes,b)))return new c.model.ShortcodeButton(_.extend({},a,{tag:b}))});return{id:b.toLowerCase().replace(/[^a-z0-9]/gi,"-"),collection:new Backbone.Collection(a)}})}});g=c.controller.Base=Backbone.Model.extend({defaults:{tag:"",atts:{},content:"",type:""},constructor:function(a){a&&a.view&&(this.view=a.view,delete a.view);Backbone.Model.apply(this,arguments)},initialize:function(){this.view.on("initialized",this.viewInitialized,this);this.view.on("copy",this.copy,this);this.view.on("edit",this.edit,this);this.view.on("add:view",this.addViewHandler,this);this.view.on("remove:view",this.removeViewHandler,this)},sortableOptions:function(){var a=this;return{tolerance:"pointer",items:"> .youxi-builder-panel",handle:".youxi-builder-panel-header",cancel:"a.button",connectWith:".youxi-builder-"+this.get("type")+"-cw",start:function(b,c){c.placeholder.css({width:c.item[0].style.width}).append('<div class="youxi-builder-panel-inner"></div>');c.helper.css({width:c.placeholder.outerWidth()});a.view.spawn("sort:subview:start",a.getMessageHash(this,c.item));a.view.childContainer&&a.view.childContainer.$el.sortable("refresh")},remove:function(b,e){var d=e.item.data("backbone.view");d instanceof c.view.Panel&&a.view.removeView(d,{silent:!0})},update:function(b,c){null==c.sender&&a.compile()},receive:function(b,e){var d=e.item.data("backbone.view");d instanceof c.view.Panel&&a.view.maybeAddView(d,{at:e.item.index(),silent:!0})},stop:function(b,c){a.view.spawn("sort:subview:stop",a.getMessageHash(this,c.item))}}},droppableOptions:function(){var a=this;return{scope:"youxi-builder",greedy:"root"!=this.get("type"),hoverClass:"ui-state-hover",tolerance:"pointer",accept:function(b){return b.is(".youxi-builder-component")&&!b.data("isDropped")&&a.validateDrop(b.data("tag"))},drop:function(b,c){var d=c.draggable.data(),d=_.extend({coords:{x:b.pageX,y:b.pageY}},_.pick(d,"tag"),d.atts||{});a.validateDrop(d.tag)&&(a.view.handleDropped.apply(a.view,[d]),c.draggable.data("isDropped",!0))}}},getShortcodeObject:function(){return f.extend(!0,{},this.get("atts")||{},{content:this.get("content")})},toShortcode:function(){var a;if(a=this.view.getChildViews(!0))a=_.map(a,function(a){return a.controller.toShortcode()}).join("\n\n"),this.set({content:a},{silent:!0});return"root"==this.get("type")?this.get("content"):f.Youxi.Shortcode.construct(this.get("tag"),this.getShortcodeObject())},edit:function(){var a=this.get("tag");f.Youxi.Shortcode.Editor(a,this.getShortcodeObject(),_.bind(function(b){if(_.isObject(b)&&_.has(b,a)){var c=_.omit(b[a],"content");b=_.has(b[a],"content")?b[a].content:"";this.set({atts:c,content:b})}},this))},copy:function(){this.view.spawn("copy:view",{object:c.Shortcode.toJSON(this.toShortcode())})},viewInitialized:f.noop,addViewHandler:function(a,b){a.controller&&(a.controller.on("change:tag",this.compile,this),a.controller.on("change:atts",this.compile,this),a.controller.on("change:content",this.compile,this));a.parent=this.view;b&&b.populate||this.compile()},removeViewHandler:function(a,b){a.controller&&a.controller.off(null,null,this);a.parent&&delete a.parent;b&&b.populate||this.compile()},toView:function(a){var b=this.getValidationStates(a.tag);if(f.isPlainObject(b)&&!b.reject){if(b.accept)return new (c.Helpers.getShortcodeClass(a.tag))(_.extend(a,{parent:this.view}));b=c.Helpers.getWrapperView(this);if(b instanceof c.view.Panel)return b.maybeAddView(a),b}},compile:function(){"root"==this.get("type")?this.view.trigger("insert:tinymce",this.toShortcode()):this.view.spawn("compile:shortcode")},populate:function(a,b){_.isString(a)?this.set("content",a):_.each(_.isArray(a)?a:[a],function(a){if(f.isPlainObject(a)&&_.has(a,"tag")){var d=this.getValidationStates(a.tag);if(f.isPlainObject(d)&&d.accept){var d=new (c.Helpers.getShortcodeClass(a.tag))({parent:this.view,tag:a.tag}),g=f.extend(!0,{},a.atts||{},{content:a.content}),h;for(h in g)g[h]=f.Youxi.Shortcode.deserialize(a.tag,h,g[h]);d.populate(a.content);d.controller&&d.controller.set({atts:_.omit(g,"content"),content:g.content});this.view.maybeAddView(d,_.extend(b||{},{populate:!0}))}}},this);b&&b.compile&&this.compile()},getMessageHash:function(a,b){return{originalSource:this.view}},getValidationStates:function(a){return c.Helpers.getValidationStates(this.get("tag"),a)},validateDrop:function(a){a=this.getValidationStates(a);return f.isPlainObject(a)&&!a.reject},dispose:function(){this.view&&this.view.off&&this.view.off(null,null,this);_.each(this.view.getChildViews()||[],function(a){a.controller&&a.controller.off&&a.controller.off(null,null,this)},this)}});c.controller.Row=g.extend({defaults:function(){return _.extend({},g.prototype.defaults,{slots:c.settings.rowSize})},validateDrop:function(a){var b=g.prototype.validateDrop.apply(this,arguments),e;if(!c.settings.simpleColumns)e=m.getMinSize();else if(e=m.getColumnByTag(a))e=e.size;return b&&f.isNumeric(e)&&this.get("slots")>=e},validate:function(a,b){if(1>a.slots||a.slots>c.settings.rowSize)return l.invalidRowSlotsSize},updateSlots:function(a,b){var c=a.previous("size"),d=this.get("slots");f.isNumeric(c)&&this.set("slots",d+c-b)},addViewHandler:function(a){a instanceof c.view.Panel&&(this.set("slots",this.get("slots")-a.controller.get("size")),a.controller.on("change:size",this.updateSlots,this));g.prototype.addViewHandler.apply(this,arguments)},removeViewHandler:function(a){a instanceof c.view.Panel&&this.set("slots",this.get("slots")+a.controller.get("size"));g.prototype.removeViewHandler.apply(this,arguments)},getMessageHash:function(a,b){var e=b.data("backbone.view"),d=g.prototype.getMessageHash.apply(this,arguments);b.is(".youxi-builder-column")&&e instanceof c.view.Panel&&_.extend(d,{columnSize:e.controller.get("size")});return d}});m=c.controller.Column=g.extend({defaults:function(){return _.extend({},g.prototype.defaults,{size:c.settings.rowSize})},initialize:function(){g.prototype.initialize.apply(this,arguments);this.view.on("increase decrease",this.resize,this);if(!c.settings.simpleColumns)this.on("change:atts",this.synchronize,this);this.on("change:size",this.synchronize,this)},viewInitialized:function(){this.trigger("change:size",this,this.get("size"))},validate:function(a,b){if(1>a.size||a.size>c.settings.rowSize)return l.invalidColumnSize;if(this.view.spawn("request:slots!")<a.size-this.get("size"))return l.notEnoughColumnSlots},copy:f.noop,resize:function(a){if(_.isElement(a.currentTarget)){a=f(a.currentTarget).data("action");var b={increase:"getNextSize",decrease:"getPrevSize"};_.has(b,a)&&(a=m[b[a]](this.get("size")),_.isUndefined(a)||this.set(_.pick(a,"tag","size"),{validate:!0}))}},synchronize:function(a,b){c.settings.simpleColumns||(f.isPlainObject(b)&&_.has(b,"size")?this.set({size:parseInt(b.size)}):f.isNumeric(b)&&this.set({atts:_.extend({},this.get("atts"),{size:parseInt(b)})}));this.view.refresh(this.get("size"))}},{isColumnContainer:function(a){return a===c.settings.columnContainerShortcode},getColumnByTag:_.memoize(function(a){return _.find(c.settings.columnShortcodes||[],function(b){return b.tag==a})}),getBestFit:_.memoize(function(a){return _.find(c.settings.columnShortcodes||[],function(b){return b.size==a})||m.getPrevSize(a)}),getNextSize:_.memoize(function(a){return _.find(c.settings.columnShortcodes||[],function(b){return b.size>a})}),getPrevSize:_.memoize(function(a){return _.find(_.clone(c.settings.columnShortcodes||[]).reverse(),function(b){return b.size<a})}),getMinSize:_.memoize(function(){return Math.min.apply(Math,_.map(c.settings.columnShortcodes||[],function(a){return a.size}))}),getTitle:_.memoize(function(a){var b=function(a,c){return c?b(c,a%c):Math.abs(a)},e=_.memoize(function(a,c){var e=b(a,c);return[a/e,c/e]});return function(){return l.columnTitlePrefix+e(a,c.settings.rowSize).join("/")}})})})(jQuery,window,document);