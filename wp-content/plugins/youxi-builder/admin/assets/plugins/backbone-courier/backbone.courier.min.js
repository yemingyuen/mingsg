/*
 * Backbone.Courier, v0.6.1
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(b,g){"function"===typeof define&&define.amd?define(["underscore","backbone","jquery"],g):"undefined"!==typeof exports?module.exports=g(require("underscore"),require("backbone"),require("backbone").$):g(b._,b.Backbone,b.jQuery||b.Zepto||b.$)})(this,function(b,g,k){var n=/^(\S+)\s*(.*)$/,p=b.isFunction(k)?k("body")[0]:null;g.Courier={};g.Courier.add=function(e){function k(a){b.isFunction(a.$el.data)&&!a.$el.data("view")&&a.$el.data("view",a)}function m(a,l,h){var d=[],f;for(f in a){var c=f.match(n),e=c[1],c=c[2];(new RegExp(e.replace("*","[\\w]*"))).test(l.name)&&(""!==c&&h._getChildViewNamed(c)!==l.source||d.push({eventName:e,subviewName:c,value:a[f]}))}1<d.length&&(d=b.sortBy(d,function(a){var c=a.eventName.replace("*","");return-((""!==a.subviewName?1E3:0)+c.length)}));return d.length?d[0].value:null}var q=e.setElement;e.spawn=function(a,l){if(b.isString(a))a={name:a,data:b.extend({},l)};else if(b.isUndefined(a.name))throw Error("Undefined message name.");a.source=e;a.data=a.data||{};this.trigger(a.name,a.data);for(var h="!"===a.name[a.name.length-1],d=this._getParentView(),f,c;d;){if(b.isObject(d.onMessages)&&(c=m(d.onMessages,a,d),null!==c)){f=c;b.isFunction(f)||(f=d[c]);if(!f)throw Error('Method "'+c+'" does not exist');c=f.call(d,a);if(h)return c}f=!1;c=b.result(d,"passMessages");if(b.isObject(c))if(c=m(c,a,d),null!==c){if("."!==c)if(b.isString(c))a.name=c;else if(b.isFunction(c))f=a.data,a.data={},c.call(d,a,f);else throw new TypeError("Values of passMessages hash should be strings or functions.");f=!0}else h&&(f=!0);h&&(f=!0);if(!f)break;a.source=d;d=d._getParentView()}if(h)throw Error('Round trip message "'+a.name+'" was not handled. All round trip messages must be handled.');};b.isFunction(e._getParentView)||(e._getParentView=function(){for(var a=null,b=this.$el.parent();0<b.length&&b[0]!==p;){var e=b.data("view");if(e&&e instanceof g.View){a=e;break}b=b.parent()}return a});b.isFunction(e._getChildViewNamed)||(e._getChildViewNamed=function(a){return b.isObject(this.subviews)?this.subviews[a]:null});e.setElement=function(a,b){var g=q.call(this,a,b);k(e);return g};e.$el&&k(e)};return g.Courier});